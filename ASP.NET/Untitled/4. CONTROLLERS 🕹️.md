## 4.1 Fundamentos dos Controllers

Os controllers são componentes fundamentais no padrão MVC, funcionando como intermediários que gerenciam o fluxo de dados entre o modelo e a visualização. No ASP.NET Core MVC, os controllers são classes que derivam da classe base Controller e contêm métodos públicos chamados "actions".

```csharp
using Microsoft.AspNetCore.Mvc;

namespace CalcadosOmega.Controllers
{
    public class HomeController : Controller
    {
        public IActionResult Index()
        {
            return View();
        }
    }
}
```

Características principais:

- Processam requisições HTTP
- Interagem com o modelo para buscar ou atualizar dados
- Selecionam a view apropriada para apresentar
- Retornam dados formatados (HTML, JSON, etc.)

## 4.2 Tipos de Ações

As actions de um controller podem retornar diferentes tipos de resultados:

**ViewResult**: Renderiza uma view

```csharp
public IActionResult Details(int id)
{
    var modelo = _repository.GetById(id);
    return View(modelo);
}
```

**JsonResult**: Retorna dados formatados como JSON

```csharp
public IActionResult GetDadosProducao(int turnoId)
{
    var dados = _producaoService.ObterDadosTurno(turnoId);
    return Json(dados);
}
```

**RedirectResult**: Redireciona para outra ação ou URL

```csharp
public IActionResult SalvarModelo(ModeloCalcado modelo)
{
    _repository.Add(modelo);
    return RedirectToAction("Index");
}
```

**FileResult**: Retorna um arquivo para download

```csharp
public IActionResult DownloadRelatorio(int id)
{
    var bytes = _relatorioService.GerarPdf(id);
    return File(bytes, "application/pdf", $"Relatorio-{id}.pdf");
}
```

**StatusCodeResult**: Retorna um código de status HTTP específico

```csharp
public IActionResult VerificarDisponibilidade(int modeloId)
{
    if (!_estoqueService.ModeloExiste(modeloId))
        return NotFound();
    
    return Ok();
}
```

## 4.3 Passagem de Dados para Views

Existem diferentes maneiras de passar dados dos controllers para as views:

**1. Modelo Fortemente Tipado**

```csharp
public IActionResult Detalhes(int id)
{
    var modelo = _modeloRepository.GetById(id);
    return View(modelo); // Passa o modelo diretamente para a view
}
```

**2. ViewData**

```csharp
public IActionResult Dashboard()
{
    ViewData["TotalProduzido"] = _producaoService.ObterTotalDiario();
    ViewData["Titulo"] = "Dashboard de Produção";
    return View();
}
```

**3. ViewBag**

```csharp
public IActionResult Estatisticas()
{
    ViewBag.MediaProducao = _estatisticaService.CalcularMediaSemanal();
    ViewBag.PeriodoAnalise = "Última semana";
    return View();
}
```

**4. TempData**

```csharp
public IActionResult ExcluirModelo(int id)
{
    _modeloRepository.Delete(id);
    TempData["Mensagem"] = "Modelo excluído com sucesso!";
    return RedirectToAction("Index");
}
```

## 4.4 Prática: Criando Controllers para a Calçados Omega

Vamos implementar controllers específicos para gerenciar modelos de calçados e turnos de produção:

**ModeloCalcadoController.cs**

```csharp
using CalcadosOmega.Models;
using CalcadosOmega.Services;
using Microsoft.AspNetCore.Mvc;

namespace CalcadosOmega.Controllers
{
    public class ModeloCalcadoController : Controller
    {
        private readonly IModeloCalcadoRepository _repository;
        private readonly IEstoqueService _estoqueService;

        public ModeloCalcadoController(IModeloCalcadoRepository repository, 
                                       IEstoqueService estoqueService)
        {
            _repository = repository;
            _estoqueService = estoqueService;
        }

        // Listar todos os modelos
        public IActionResult Index()
        {
            var modelos = _repository.GetAll();
            return View(modelos);
        }

        // Detalhes de um modelo específico
        public IActionResult Detalhes(int id)
        {
            var modelo = _repository.GetById(id);
            
            if (modelo == null)
                return NotFound();
                
            // Verificar disponibilidade em estoque
            ViewBag.DisponibilidadeEstoque = _estoqueService.VerificarDisponibilidade(id);
            
            return View(modelo);
        }

        // Formulário para criar modelo
        public IActionResult Criar()
        {
            ViewBag.Categorias = _repository.GetAllCategorias();
            return View();
        }

        // Processar criação de modelo
        [HttpPost]
        [ValidateAntiForgeryToken]
        public IActionResult Criar(ModeloCalcado modelo)
        {
            if (ModelState.IsValid)
            {
                _repository.Add(modelo);
                TempData["Mensagem"] = "Modelo cadastrado com sucesso!";
                return RedirectToAction(nameof(Index));
            }
            
            ViewBag.Categorias = _repository.GetAllCategorias();
            return View(modelo);
        }

        // Formulário para editar modelo
        public IActionResult Editar(int id)
        {
            var modelo = _repository.GetById(id);
            
            if (modelo == null)
                return NotFound();
                
            ViewBag.Categorias = _repository.GetAllCategorias();
            return View(modelo);
        }

        // Processar edição de modelo
        [HttpPost]
        [ValidateAntiForgeryToken]
        public IActionResult Editar(ModeloCalcado modelo)
        {
            if (ModelState.IsValid)
            {
                _repository.Update(modelo);
                TempData["Mensagem"] = "Modelo atualizado com sucesso!";
                return RedirectToAction(nameof(Index));
            }
            
            ViewBag.Categorias = _repository.GetAllCategorias();
            return View(modelo);
        }

        // Confirmar exclusão
        public IActionResult ConfirmarExclusao(int id)
        {
            var modelo = _repository.GetById(id);
            
            if (modelo == null)
                return NotFound();
                
            return View(modelo);
        }

        // Processar exclusão
        [HttpPost, ActionName("Excluir")]
        [ValidateAntiForgeryToken]
        public IActionResult ExecutarExclusao(int id)
        {
            _repository.Delete(id);
            TempData["Mensagem"] = "Modelo excluído com sucesso!";
            return RedirectToAction(nameof(Index));
        }

        // API para busca de modelos
        [HttpGet]
        public IActionResult BuscarModelos(string termo)
        {
            var resultados = _repository.Search(termo);
            return Json(resultados);
        }

        // Relatório de produção por modelo
        public IActionResult RelatorioPorModelo(int id)
        {
            var modelo = _repository.GetById(id);
            
            if (modelo == null)
                return NotFound();
                
            var dadosProducao = _repository.GetDadosProducao(id);
            
            return View(new ModeloRelatorioViewModel
            {
                Modelo = modelo,
                DadosProducao = dadosProducao
            });
        }
    }
}
```

**TurnoProducaoController.cs**

```csharp
using CalcadosOmega.Models;
using CalcadosOmega.Services;
using Microsoft.AspNetCore.Mvc;

namespace CalcadosOmega.Controllers
{
    public class TurnoProducaoController : Controller
    {
        private readonly ITurnoProducaoRepository _repository;
        private readonly IProducaoService _producaoService;

        public TurnoProducaoController(ITurnoProducaoRepository repository,
                                       IProducaoService producaoService)
        {
            _repository = repository;
            _producaoService = producaoService;
        }

        // Listar todos os turnos
        public IActionResult Index()
        {
            var turnos = _repository.GetAllWithStats();
            return View(turnos);
        }

        // Detalhes de um turno específico
        public IActionResult Detalhes(int id)
        {
            var turno = _repository.GetById(id);
            
            if (turno == null)
                return NotFound();
                
            // Carregar informações adicionais
            ViewBag.EstatisticasTurno = _producaoService.ObterEstatisticas(id);
            ViewBag.ModelosProduzidos = _producaoService.ObterModelosProduzidos(id);
            
            return View(turno);
        }

        // Dashboard de produção por turno
        public IActionResult Dashboard()
        {
            var viewModel = new DashboardTurnoViewModel
            {
                TurnoAtual = _producaoService.ObterTurnoAtual(),
                ProducaoSemanal = _producaoService.ObterProducaoSemanal(),
                EficienciaTurnos = _producaoService.CalcularEficienciaTurnos(),
                ProblemasPorTurno = _producaoService.IdentificarProblemasPorTurno()
            };
            
            return View(viewModel);
        }

        // Registrar início de turno
        [HttpPost]
        [ValidateAntiForgeryToken]
        public IActionResult IniciarTurno(TurnoProducao turno)
        {
            if (ModelState.IsValid)
            {
                _repository.Add(turno);
                TempData["Mensagem"] = "Turno iniciado com sucesso!";
                return RedirectToAction(nameof(Index));
            }
            
            return View(turno);
        }

        // Registrar encerramento de turno
        [HttpPost]
        [ValidateAntiForgeryToken]
        public IActionResult EncerrarTurno(int id, TurnoEncerramento dados)
        {
            if (ModelState.IsValid)
            {
                var resultado = _producaoService.EncerrarTurno(id, dados);
                
                if (resultado.Sucesso)
                {
                    TempData["Mensagem"] = "Turno encerrado com sucesso!";
                    return RedirectToAction(nameof(Index));
                }
                
                ModelState.AddModelError("", resultado.Mensagem);
            }
            
            var turno = _repository.GetById(id);
            return View(turno);
        }

        // Relatório de produção por período
        public IActionResult RelatorioPorPeriodo(DateTime dataInicio, DateTime dataFim)
        {
            if (dataFim < dataInicio)
            {
                TempData["Erro"] = "A data final deve ser maior que a data inicial.";
                return RedirectToAction(nameof(Index));
            }
            
            var relatorio = _producaoService.GerarRelatorioPorPeriodo(dataInicio, dataFim);
            return View(relatorio);
        }

        // API para dados em tempo real
        [HttpGet]
        public IActionResult DadosTempoReal(int turnoId)
        {
            var dados = _producaoService.ObterDadosTempoReal(turnoId);
            return Json(dados);
        }
    }
}
```

## 4.5 Padrões de Design para Controllers

Para manter os controllers organizados e facilitar a manutenção, recomendamos seguir alguns padrões de design:

### 1. Controladores Magros, Serviços Gordos

Mantenha a lógica de negócios fora dos controllers, delegando-a para classes de serviço:

```csharp
// Ruim - Lógica no controller
public IActionResult CalcularEficiencia(int turnoId)
{
    var turno = _repository.GetById(turnoId);
    var producaoTotal = turno.Itens.Sum(i => i.Quantidade);
    var horasTrabalhadas = (turno.HoraFim - turno.HoraInicio).TotalHours;
    var eficiencia = producaoTotal / horasTrabalhadas;
    // ...
}

// Bom - Lógica em serviços
public IActionResult CalcularEficiencia(int turnoId)
{
    var eficiencia = _producaoService.CalcularEficienciaTurno(turnoId);
    return View(eficiencia);
}
```

### 2. Injeção de Dependências

Use injeção de dependências para acessar serviços e repositórios:

csharpresponse-action-icon

```csharp
public class ProducaoController : Controller
{
    private readonly IProducaoRepository _repository;
    private readonly ICalculoEficienciaService _calculoService;
    private readonly ILogger<ProducaoController> _logger;

    public ProducaoController(
        IProducaoRepository repository,
        ICalculoEficienciaService calculoService,
        ILogger<ProducaoController> logger)
    {
        _repository = repository;
        _calculoService = calculoService;
        _logger = logger;
    }
    
    // Actions...
}
```

### 3. RESTful APIs

Para APIs, siga os princípios RESTful:

csharpresponse-action-icon

```csharp
[ApiController]
[Route("api/[controller]")]
public class ModelosApiController : ControllerBase
{
    private readonly IModeloCalcadoRepository _repository;

    public ModelosApiController(IModeloCalcadoRepository repository)
    {
        _repository = repository;
    }

    // GET: api/modelosapi
    [HttpGet]
    public IActionResult GetAll()
    {
        return Ok(_repository.GetAll());
    }

    // GET: api/modelosapi/5
    [HttpGet("{id}")]
    public IActionResult GetById(int id)
    {
        var modelo = _repository.GetById(id);
        
        if (modelo == null)
            return NotFound();
            
        return Ok(modelo);
    }

    // POST: api/modelosapi
    [HttpPost]
    public IActionResult Create([FromBody] ModeloCalcado modelo)
    {
        if (!ModelState.IsValid)
            return BadRequest(ModelState);
            
        _repository.Add(modelo);
        
        return CreatedAtAction(nameof(GetById), new { id = modelo.Id }, modelo);
    }

    // PUT: api/modelosapi/5
    [HttpPut("{id}")]
    public IActionResult Update(int id, [FromBody] ModeloCalcado modelo)
    {
        if (id != modelo.Id)
            return BadRequest();
            
        if (!ModelState.IsValid)
            return BadRequest(ModelState);
            
        try
        {
            _repository.Update(modelo);
        }
        catch (Exception)
        {
            if (!_repository.Exists(id))
                return NotFound();
            throw;
        }
        
        return NoContent();
    }

    // DELETE: api/modelosapi/5
    [HttpDelete("{id}")]
    public IActionResult Delete(int id)
    {
        var modelo = _repository.GetById(id);
        
        if (modelo == null)
            return NotFound();
            
        _repository.Delete(id);
        
        return NoContent();
    }
}
```

### 4. Filtros de Ação

Use filtros para adicionar comportamentos transversais:

csharpresponse-action-icon

```csharp
// Filtro personalizado para log de operações críticas
public class LogOperacoesCriticasAttribute : ActionFilterAttribute
{
    private readonly ILogger<LogOperacoesCriticasAttribute> _logger;

    public LogOperacoesCriticasAttribute(ILogger<LogOperacoesCriticasAttribute> logger)
    {
        _logger = logger;
    }

    public override void OnActionExecuting(ActionExecutingContext context)
    {
        _logger.LogInformation(
            "Operação crítica iniciada: {Controller}.{Action} por {User} em {Time}",
            context.Controller.GetType().Name,
            context.ActionDescriptor.DisplayName,
            context.HttpContext.User.Identity.Name,
            DateTime.Now);
            
        base.OnActionExecuting(context);
    }
}

// Uso do filtro em controller ou action
[LogOperacoesCriticas]
public IActionResult AlterarConfiguracaoProducao(ConfiguracaoProducao config)
{
    // ...
}
```

### 5. ViewModel Dedicadas

Use ViewModels específicas para cada ação:

csharpresponse-action-icon

```csharp
public class DetalhesModeloViewModel
{
    public ModeloCalcado Modelo { get; set; }
    public int QuantidadeProduzida { get; set; }
    public int EstoqueAtual { get; set; }
    public List<Fornecedor> Fornecedores { get; set; }
    public List<HistoricoProducao> HistoricoProducao { get; set; }
}

public IActionResult Detalhes(int id)
{
    var modelo = _repository.GetById(id);
    
    if (modelo == null)
        return NotFound();
        
    var viewModel = new DetalhesModeloViewModel
    {
        Modelo = modelo,
        QuantidadeProduzida = _producaoService.CalcularTotalProduzido(id),
        EstoqueAtual = _estoqueService.ObterQuantidadeAtual(id),
        Fornecedores = _fornecedorService.ListarPorModelo(id),
        HistoricoProducao = _producaoService.ObterHistorico(id)
    };
    
    return View(viewModel);
}
```